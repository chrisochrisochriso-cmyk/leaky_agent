<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>leaky_agent ‚Äî Stats Dashboard</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f6f8;
      color: #1a1a2e;
      padding: 24px 20px 60px;
    }
    .container { max-width: 1000px; margin: 0 auto; }

    h1 { font-size: 1.5rem; margin-bottom: 6px; }
    .subtitle { color: #666; font-size: 0.9rem; margin-bottom: 28px; }
    .subtitle a { color: #0066cc; }

    /* ‚îÄ‚îÄ Summary cards ‚îÄ‚îÄ */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,.07);
      text-align: center;
    }
    .card-number { font-size: 2.2rem; font-weight: 700; color: #dc3545; }
    .card-label  { font-size: 0.78rem; color: #666; margin-top: 6px; text-transform: uppercase; letter-spacing: .04em; }

    /* ‚îÄ‚îÄ Panels ‚îÄ‚îÄ */
    .panel {
      background: #fff;
      border-radius: 8px;
      padding: 22px 24px;
      margin-bottom: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,.07);
    }
    .panel h3 { font-size: 0.95rem; margin-bottom: 16px; text-transform: uppercase; letter-spacing: .04em; color: #555; }

    /* ‚îÄ‚îÄ Bar chart rows ‚îÄ‚îÄ */
    .bar-row {
      display: grid;
      grid-template-columns: 180px 1fr 48px;
      align-items: center;
      gap: 12px;
      padding: 7px 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.87rem;
    }
    .bar-row:last-child { border-bottom: none; }
    .bar-track { background: #f0f0f0; border-radius: 4px; height: 14px; }
    .bar-fill  { background: #dc3545; border-radius: 4px; height: 14px; min-width: 4px; transition: width .4s; }
    .bar-fill.severity-high     { background: #fd7e14; }
    .bar-fill.severity-medium   { background: #ffc107; }
    .bar-fill.severity-unknown  { background: #6c757d; }
    .bar-count { text-align: right; color: #666; }

    /* ‚îÄ‚îÄ Recent events ‚îÄ‚îÄ */
    .event-row { padding: 9px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.84rem; }
    .event-row:last-child { border-bottom: none; }
    .event-time { color: #aaa; font-size: 0.78rem; }
    .sev-badge {
      display: inline-block;
      padding: 1px 7px;
      border-radius: 3px;
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      vertical-align: middle;
    }
    .sev-critical { background: #ffe0e0; color: #9b1c1c; }
    .sev-high     { background: #fff3cd; color: #856404; }
    .sev-medium   { background: #e8f4e8; color: #2d7a2d; }
    .sev-unknown  { background: #e8e8e8; color: #555; }

    /* ‚îÄ‚îÄ Status ‚îÄ‚îÄ */
    .status { font-size: 0.8rem; color: #999; text-align: center; margin-top: 20px; }
    .status a { color: #0066cc; }
    .error-msg { color: #dc3545; background: #ffe0e0; padding: 12px; border-radius: 5px; font-size: 0.85rem; }
    .loading   { color: #aaa; font-size: 0.87rem; padding: 12px 0; }
  </style>
</head>
<body>
<div class="container">

  <h1>üçØ leaky_agent ‚Äî Stats Dashboard</h1>
  <p class="subtitle">
    Live aggregate data from the AI agent security honeypot.
    <a href="/">Back to honeypot</a> &nbsp;|&nbsp;
    <a href="https://github.com/chrisochrisochriso-cmyk/leaky_agent">Source ‚Üí</a>
  </p>

  <!-- Summary cards -->
  <div class="cards">
    <div class="card"><div class="card-number" id="n-total">‚Äî</div><div class="card-label">Total Events</div></div>
    <div class="card"><div class="card-number" id="n-agents">‚Äî</div><div class="card-label">Unique Agent Types</div></div>
    <div class="card"><div class="card-number" id="n-critical">‚Äî</div><div class="card-label">Critical Breaches</div></div>
    <div class="card"><div class="card-number" id="n-days">‚Äî</div><div class="card-label">Days Active</div></div>
  </div>

  <!-- Worker stats: category + source breakdown (shown only when Worker is configured) -->
  <div id="worker-stats-section" style="display:none;">
    <div class="panel">
      <h3>Breaches by Category</h3>
      <div id="category-bars" class="loading">Loading from Worker‚Ä¶</div>
    </div>
    <div class="panel">
      <h3>Event Source</h3>
      <p style="font-size:0.8rem;color:#888;margin-bottom:12px;">
        <strong>canary_request</strong> = page visit logged (any agent) &nbsp;|&nbsp;
        <strong>beacon</strong> = passive trap fired (WebFetch / no-JS agents)
      </p>
      <div id="source-bars" class="loading">Loading‚Ä¶</div>
    </div>
  </div>

  <!-- Trap type breakdown -->
  <div class="panel">
    <h3>Breaches by Trap Type</h3>
    <div id="trap-bars" class="loading">Loading from GitHub‚Ä¶</div>
  </div>

  <!-- Agent type breakdown -->
  <div class="panel">
    <h3>Breaches by Agent</h3>
    <div id="agent-bars" class="loading">Loading‚Ä¶</div>
  </div>

  <!-- Recent events -->
  <div class="panel">
    <h3>Recent Events (last 20)</h3>
    <div id="recent-events" class="loading">Loading‚Ä¶</div>
  </div>

  <div class="status">
    GitHub data refreshes every 2 minutes (public API, no auth) &nbsp;|&nbsp;
    Worker data refreshes every 60 seconds (when configured) &nbsp;|&nbsp;
    Last refresh: <span id="last-refresh">‚Äî</span>
  </div>

</div><!-- /container -->

<script src="config.js"></script>
<script>
// stats.html ‚Äî reads breach events from GitHub Issues comments
// Public read, no auth required for public repos.
// Rate limit: 60 unauthenticated requests/hr.
// With 120s refresh: 30 req/hr ‚Äî well within budget.

const COMMENTS_URL =
  `https://api.github.com/repos/${CONFIG.GITHUB_REPO}/issues/${CONFIG.BREACH_LOG_ISSUE}/comments?per_page=100`;

// Parse our structured JSON payload from a comment body
function parseComment(body) {
  try {
    const m = body.match(/```json\s*([\s\S]*?)```/);
    if (!m) return null;
    return JSON.parse(m[1]);
  } catch (_) {
    return null;
  }
}

async function loadStats() {
  try {
    // Paginate comments (100 per page, follow Link header if needed)
    let allEvents = [];
    let url = COMMENTS_URL;

    while (url) {
      const res = await fetch(url, {
        headers: { Accept: 'application/vnd.github.v3+json' },
      });

      if (!res.ok) {
        const msg = res.status === 404
          ? 'Breach log issue not found. Check BREACH_LOG_ISSUE in config.js.'
          : res.status === 403
          ? 'Rate limited. Try again in a minute.'
          : `GitHub API error ${res.status}.`;
        showError(msg);
        return;
      }

      const comments = await res.json();
      const events = comments.map(c => parseComment(c.body)).filter(Boolean);
      allEvents = allEvents.concat(events);

      // Follow pagination
      const link = res.headers.get('Link') || '';
      const next = link.match(/<([^>]+)>;\s*rel="next"/);
      url = next ? next[1] : null;
    }

    renderStats(allEvents);
    document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString();

  } catch (err) {
    showError(`Failed to load: ${err.message}. Ensure the repo is public and issue ${CONFIG.BREACH_LOG_ISSUE} exists.`);
  }
}

function renderStats(events) {
  const total    = events.length;
  const critical = events.filter(e => e.severity === 'critical').length;
  const agentSet = new Set(events.map(e => e.agent || 'Unknown'));

  // Days active
  const timestamps = events.map(e => new Date(e.timestamp)).filter(d => !isNaN(d));
  let daysActive = '‚Äî';
  if (timestamps.length) {
    const oldest = Math.min(...timestamps.map(d => d.getTime()));
    daysActive = Math.max(1, Math.ceil((Date.now() - oldest) / 86400000));
  }

  document.getElementById('n-total').textContent    = total;
  document.getElementById('n-agents').textContent   = agentSet.size;
  document.getElementById('n-critical').textContent = critical;
  document.getElementById('n-days').textContent     = daysActive;

  // Trap breakdown
  const trapCounts = {};
  events.forEach(e => {
    trapCounts[e.trap] = (trapCounts[e.trap] || 0) + 1;
  });
  renderBars('trap-bars', trapCounts, total, 'critical');

  // Agent breakdown
  const agentCounts = {};
  events.forEach(e => {
    const a = e.agent || 'Unknown';
    agentCounts[a] = (agentCounts[a] || 0) + 1;
  });
  renderBars('agent-bars', agentCounts, total, 'high');

  // Recent events
  const recent = events.slice(-20).reverse();
  if (!recent.length) {
    document.getElementById('recent-events').innerHTML =
      '<p style="color:#aaa;font-size:.85rem;">No events yet. Send your agent to <a href="/">leaky_agent</a>!</p>';
    return;
  }

  const rows = recent.map(e => {
    const sev = (e.severity || 'unknown').toLowerCase();
    const ts  = e.timestamp ? new Date(e.timestamp).toLocaleString() : '?';
    return `
      <div class="event-row">
        <span class="event-time">${escHtml(ts)}</span> &nbsp;
        <span class="sev-badge sev-${sev}">${escHtml(sev)}</span> &nbsp;
        <strong>${escHtml(e.trap || '?')}</strong>
        &nbsp;‚Äî ${escHtml(e.agent || 'Unknown')}
        &nbsp;<code style="font-size:.78rem;color:#888;">${escHtml(e.canary || '')}</code>
      </div>
    `;
  }).join('');
  document.getElementById('recent-events').innerHTML = rows;
}

function renderBars(containerId, counts, total, defaultSevClass) {
  const el = document.getElementById(containerId);
  if (!Object.keys(counts).length) {
    el.innerHTML = '<p class="loading">No data yet.</p>';
    return;
  }
  const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
  el.innerHTML = sorted.map(([label, count]) => {
    const pct   = total > 0 ? (count / total) * 100 : 0;
    return `
      <div class="bar-row">
        <div>${escHtml(label)}</div>
        <div class="bar-track">
          <div class="bar-fill severity-${defaultSevClass}" style="width:${pct.toFixed(1)}%"></div>
        </div>
        <div class="bar-count">${count}</div>
      </div>
    `;
  }).join('');
}

function showError(msg) {
  ['trap-bars', 'agent-bars', 'recent-events'].forEach(id => {
    document.getElementById(id).innerHTML = `<div class="error-msg">‚ö†Ô∏è ${escHtml(msg)}</div>`;
  });
}

function escHtml(s) {
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

// Load on start, then every 2 minutes (30 req/hr ‚Äî safe under 60/hr unauthenticated cap)
loadStats();
setInterval(loadStats, 120_000);

// ‚îÄ‚îÄ Worker stats (category + source breakdown) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Only active when CONFIG.CANARY_WORKER_URL is set.
// Reads /stats from the CF Worker (CORS-enabled, no auth required).
// Refreshes every 60 seconds independently of the GitHub poll.

async function loadWorkerStats() {
  if (!CONFIG.CANARY_WORKER_URL) return;

  document.getElementById('worker-stats-section').style.display = 'block';

  try {
    const res = await fetch(`${CONFIG.CANARY_WORKER_URL}/stats`);
    if (!res.ok) { workerError(`Worker returned ${res.status}`); return; }
    const data = await res.json();
    renderWorkerStats(data);
  } catch (err) {
    workerError(err.message);
  }
}

function renderWorkerStats(data) {
  const total = data.total || 1;

  // Category breakdown
  renderBarsInEl('category-bars', data.by_category || {}, total, 'critical');

  // Source breakdown
  renderBarsInEl('source-bars', data.by_source || {}, total, 'high');
}

function renderBarsInEl(elId, counts, total, cls) {
  const el = document.getElementById(elId);
  if (!el) return;
  if (!Object.keys(counts).length) {
    el.innerHTML = '<p class="loading">No data yet.</p>';
    return;
  }
  const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
  el.innerHTML = sorted.map(([label, count]) => {
    const pct = total > 0 ? (count / total) * 100 : 0;
    return `
      <div class="bar-row">
        <div>${escHtml(label)}</div>
        <div class="bar-track">
          <div class="bar-fill severity-${cls}" style="width:${pct.toFixed(1)}%"></div>
        </div>
        <div class="bar-count">${count}</div>
      </div>`;
  }).join('');
}

function workerError(msg) {
  ['category-bars', 'source-bars'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = `<div class="error-msg">‚ö†Ô∏è ${escHtml(msg)}</div>`;
  });
}

loadWorkerStats();
setInterval(loadWorkerStats, 60_000);
</script>
</body>
</html>
